#!/bin/bash
# Pre-commit hook for Apt ID project
# Runs linting and formatting checks for TypeScript, Rust, and Move

set -e

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any checks failed
FAILED=0

# Get the repository root
REPO_ROOT=$(git rev-parse --show-toplevel)

# Check for staged TypeScript files
TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -n "$TS_FILES" ]; then
    echo -e "${YELLOW}üìù Checking TypeScript files...${NC}"
    
    cd "$REPO_ROOT/typescript"
    
    # Check if node_modules exists
    if [ -d "node_modules" ]; then
        # Run ESLint
        echo "  Running ESLint..."
        if ! pnpm lint 2>/dev/null; then
            echo -e "${RED}  ‚ùå ESLint check failed${NC}"
            FAILED=1
        else
            echo -e "${GREEN}  ‚úì ESLint passed${NC}"
        fi
        
        # Run Prettier check
        echo "  Running Prettier..."
        if ! pnpm _fmt -- --check 2>/dev/null; then
            echo -e "${RED}  ‚ùå Prettier check failed. Run 'pnpm fmt' to fix.${NC}"
            FAILED=1
        else
            echo -e "${GREEN}  ‚úì Prettier passed${NC}"
        fi
    else
        echo -e "${YELLOW}  ‚ö† node_modules not found, skipping TypeScript checks${NC}"
    fi
    
    cd "$REPO_ROOT"
fi

# Check for staged Rust files
RS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.rs$' || true)

if [ -n "$RS_FILES" ]; then
    echo -e "${YELLOW}ü¶Ä Checking Rust files...${NC}"
    
    cd "$REPO_ROOT/rust/profile-processor"
    
    # Check if cargo is available
    if command -v cargo &> /dev/null; then
        # Run cargo fmt check
        echo "  Running cargo fmt..."
        if ! cargo fmt -- --check 2>/dev/null; then
            echo -e "${RED}  ‚ùå cargo fmt check failed. Run 'cargo fmt' to fix.${NC}"
            FAILED=1
        else
            echo -e "${GREEN}  ‚úì cargo fmt passed${NC}"
        fi
        
        # Run cargo clippy
        echo "  Running cargo clippy..."
        if ! cargo clippy --all-targets --all-features -- -D warnings 2>/dev/null; then
            echo -e "${RED}  ‚ùå cargo clippy check failed${NC}"
            FAILED=1
        else
            echo -e "${GREEN}  ‚úì cargo clippy passed${NC}"
        fi
    else
        echo -e "${YELLOW}  ‚ö† cargo not found, skipping Rust checks${NC}"
    fi
    
    cd "$REPO_ROOT"
fi

# Check for staged Move files
MOVE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.move$' || true)

if [ -n "$MOVE_FILES" ]; then
    echo -e "${YELLOW}üì¶ Checking Move files...${NC}"
    
    cd "$REPO_ROOT/move"
    
    # Check if aptos CLI is available
    if command -v aptos &> /dev/null; then
        # Run Move compile to validate syntax
        echo "  Running aptos move compile..."
        if ! aptos move compile --skip-fetch-latest-git-deps 2>/dev/null; then
            echo -e "${RED}  ‚ùå Move compilation failed${NC}"
            FAILED=1
        else
            echo -e "${GREEN}  ‚úì Move compilation passed${NC}"
        fi
    else
        echo -e "${YELLOW}  ‚ö† aptos CLI not found, skipping Move checks${NC}"
    fi
    
    cd "$REPO_ROOT"
fi

# Final result
if [ $FAILED -eq 1 ]; then
    echo -e "\n${RED}‚ùå Pre-commit checks failed. Please fix the issues above.${NC}"
    exit 1
fi

echo -e "\n${GREEN}‚úÖ All pre-commit checks passed!${NC}"
exit 0
